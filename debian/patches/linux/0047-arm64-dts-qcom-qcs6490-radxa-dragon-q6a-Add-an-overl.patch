From a40d8816b42b8c563c351a687a6f992d3005f49e Mon Sep 17 00:00:00 2001
From: Xilin Wu <sophon@radxa.com>
Date: Mon, 28 Jul 2025 12:44:48 +0800
Subject: [PATCH 47/49] arm64: dts: qcom: qcs6490-radxa-dragon-q6a: Add an
 overlay to enable KVM

Signed-off-by: Xilin Wu <sophon@radxa.com>
---
 arch/arm64/boot/dts/qcom/Makefile                |  2 ++
 .../dts/qcom/qcs6490-radxa-dragon-q6a-kvm.dtso   | 16 ++++++++++++++++
 2 files changed, 18 insertions(+)
 create mode 100644 arch/arm64/boot/dts/qcom/qcs6490-radxa-dragon-q6a-kvm.dtso

diff --git a/src/arch/arm64/boot/dts/qcom/Makefile b/src/arch/arm64/boot/dts/qcom/Makefile
index 341633c7090d..647322a9fce1 100644
--- a/src/arch/arm64/boot/dts/qcom/Makefile
+++ b/src/arch/arm64/boot/dts/qcom/Makefile
@@ -123,6 +123,7 @@ qcs6490-rb3gen2-industrial-mezzanine-dtbs := qcs6490-rb3gen2.dtb qcs6490-rb3gen2
 qcs6490-radxa-dragon-q6a-cam1-imx577-dtbs	:= qcs6490-radxa-dragon-q6a.dtb qcs6490-radxa-dragon-q6a-cam1-imx577.dtbo
 qcs6490-radxa-dragon-q6a-cam2-radxa-camera-8m-219-dtbs	:= qcs6490-radxa-dragon-q6a.dtb qcs6490-radxa-dragon-q6a-cam2-radxa-camera-8m-219.dtbo
 qcs6490-radxa-dragon-q6a-cam3-radxa-camera-8m-219-dtbs	:= qcs6490-radxa-dragon-q6a.dtb qcs6490-radxa-dragon-q6a-cam3-radxa-camera-8m-219.dtbo
+qcs6490-radxa-dragon-q6a-kvm-dtbs	:= qcs6490-radxa-dragon-q6a.dtb qcs6490-radxa-dragon-q6a-kvm.dtbo
 qcs6490-radxa-dragon-q6a-radxa-display-10fhd-dtbs	:= qcs6490-radxa-dragon-q6a.dtb qcs6490-radxa-dragon-q6a-radxa-display-10fhd.dtbo
 
 dtb-$(CONFIG_ARCH_QCOM)	+= qcs6490-rb3gen2-industrial-mezzanine.dtb
@@ -130,6 +131,7 @@ dtb-$(CONFIG_ARCH_QCOM)	+= qcs6490-rb3gen2-vision-mezzanine.dtb
 dtb-$(CONFIG_ARCH_QCOM)	+= qcs6490-radxa-dragon-q6a-cam1-imx577.dtb
 dtb-$(CONFIG_ARCH_QCOM)	+= qcs6490-radxa-dragon-q6a-cam2-radxa-camera-8m-219.dtb
 dtb-$(CONFIG_ARCH_QCOM)	+= qcs6490-radxa-dragon-q6a-cam3-radxa-camera-8m-219.dtb
+dtb-$(CONFIG_ARCH_QCOM)	+= qcs6490-radxa-dragon-q6a-kvm.dtb
 dtb-$(CONFIG_ARCH_QCOM)	+= qcs6490-radxa-dragon-q6a-radxa-display-10fhd.dtb
 dtb-$(CONFIG_ARCH_QCOM)	+= qcs8300-ride.dtb
 dtb-$(CONFIG_ARCH_QCOM)	+= qcs8550-aim300-aiot.dtb
diff --git a/src/arch/arm64/boot/dts/qcom/qcs6490-radxa-dragon-q6a-kvm.dtso b/src/arch/arm64/boot/dts/qcom/qcs6490-radxa-dragon-q6a-kvm.dtso
new file mode 100644
index 000000000000..806014e13e2b
--- /dev/null
+++ b/src/arch/arm64/boot/dts/qcom/qcs6490-radxa-dragon-q6a-kvm.dtso
@@ -0,0 +1,16 @@
+// SPDX-License-Identifier: BSD-3-Clause
+/*
+ * Copyright (c) 2025 Radxa Computer (Shenzhen) Co., Ltd.
+ */
+
+/dts-v1/;
+/plugin/;
+
+&{/chosen} {
+	radxa,enable-kvm = <1>;
+};
+
+/* We can't and don't need to use zap shader in EL2 as linux can zap the gpu on it's own. */
+&gpu_zap_shader {
+	status = "disabled";
+};
-- 
2.50.1

